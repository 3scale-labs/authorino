echo-api:3000:
  enabled: true

  identity:
    - oidc:
        name: keycloak
        endpoint: http://keycloak:8080/auth/realms/ostia
    # - mtls:
    #     pem: |
    #       -----BEGIN CERTIFICATE-----
    #       MIIGwjCCBKqgAwIBAgIUJzDCEo9B7q3q+q5lJFvITLyBiAAwDQYJKoZIhvcNAQEL
    #       BQAwgaIxCzAJBgNVBAYTAkVTMRIwEAYDVQQIDAlCYXJjZWxvbmExEjAQBgNVBAcM
    #       CUJhcmNlbG9uYTEWMBQGA1UECgwNUmVkIEhhdCwgSW5jLjEXMBUGA1UECwwOUmVk
    #       IEhhdCAzc2NhbGUxOjA4BgNVBAMMMUtleWNsb2FrIFNlcnZlciBvbiAzc2NhbGUg
    #       T3BlblNoaWZ0IGRldmVsIGNsdXN0ZXIwHhcNMjAwNTEzMTM1NTEyWhcNMzAwNTEx
    #       MTM1NTEyWjCBojELMAkGA1UEBhMCRVMxEjAQBgNVBAgMCUJhcmNlbG9uYTESMBAG
    #       A1UEBwwJQmFyY2Vsb25hMRYwFAYDVQQKDA1SZWQgSGF0LCBJbmMuMRcwFQYDVQQL
    #       DA5SZWQgSGF0IDNzY2FsZTE6MDgGA1UEAwwxS2V5Y2xvYWsgU2VydmVyIG9uIDNz
    #       Y2FsZSBPcGVuU2hpZnQgZGV2ZWwgY2x1c3RlcjCCAiIwDQYJKoZIhvcNAQEBBQAD
    #       ggIPADCCAgoCggIBALEP5Ef+JTO07E6bsjquMOTRWyXjfN6nau6VGpRpVHOmilkJ
    #       cw39NsxWNCbI619OA+uYCB9TOvAikwEljsYDe5nVYDinNdogln5S+bsc0yIFS320
    #       x/GpMBRWMSJFo1uBQNs9aAl30QGl+GTpKHlME/z0caXRRRPd45926Sf09tMfq5Gf
    #       LSFqLt+hpOpPByZ9db8yg31rLlULHPrJ0QC2/1G/A4o7BjC+lLxP8kWL+R0PzF2n
    #       pSFdhV11yFWHC+X7gxo7RDbiz2hfWeEXPUWQHuZ2+iDzasJgMficslPdaffUNArC
    #       9cIbJTQqEKJ3Ob43Nu7ufvANcXrioBsVGLPxK90s+3sZAI0Iyf0BHu7XQoy/5Sl6
    #       nN5/AxiZyQjAQWXN9TLHGqO0/NLpydO/tQkV/fkLUJDlas7/5wGpO+g62nA+frV0
    #       AnC7Yvcx5CYBnTlpU194XtiXdrWvJ/PKvbXq3tk8IciKAV29PIi8Miv8+UF/p3PQ
    #       oCdipAeSsBxtdiVbHy6ibllSwNN0QbzezncPxEE+5FwGDljW69PN+LkpQV3OfNIP
    #       OW++HI0VK8WtLbfVUEIiiGQDhngp/HpI8DThh5ZUVPgYjZo8zDGC8vGHvjfioPyL
    #       t6grzq+mNHxSSOJa4apte/Bz8Jqmjuegy1fbAlYpG6kxrIzq4XRiqVdTMetbAgMB
    #       AAGjge0wgeowHQYDVR0OBBYEFCa8PvO0lTNo1ohbif/ubPBkKIdnMB8GA1UdIwQY
    #       MBaAFCa8PvO0lTNo1ohbif/ubPBkKIdnMA8GA1UdEwEB/wQFMAMBAf8wgZYGA1Ud
    #       EQSBjjCBi4I7a2V5Y2xvYWsta2V5Y2xvYWstb3BlcmF0b3IuYXBwcy5kZXYtZW5n
    #       LW9jcDQtMy5kZXYuM3NjYS5uZXSCHmtleWNsb2FrLmtleWNsb2FrLW9wZXJhdG9y
    #       LnN2Y4Isa2V5Y2xvYWsua2V5Y2xvYWstb3BlcmF0b3Iuc3ZjLmNsdXN0ZXIubG9j
    #       YWwwDQYJKoZIhvcNAQELBQADggIBAIFfr2hTkMoVAJ7UmbfsIVRY+0Uj2kkkKwme
    #       VJ8gbMAbH51JhDCjnj7cIlKDszWZh1L7D9jXjqfVip6w8j1pekaM62IlupUjfdE9
    #       c1Ngv8Za45cXM62UDCKUfrOI2vbIBqyCoPrgwzeRoeAcdFuIiP7VcZJ/qrLIB79T
    #       LXEkU54UHOHOcAX2IDWI1dWFAdYtMlEGlTKfd/uVOGOu/hM5kRn41xAeAEfYFv2G
    #       xSZU94oBZ2erRYQ2IzRNG0tyrnHw9LZSWSj5G/Ifq6MY0zYnMLD/TWSc9u5zoLMp
    #       NemAX981WKXUsedPfJI1V2RVpwyy1qM21nF3k2SXN7QODd0l+Mdb29hse/jVsAG3
    #       gdrxLpStOq5A14nrhijnvHjfAg5uivd0iRRqTkZuHwQ/rwW9Zbpk+JiLHsY+sHVJ
    #       f80uPz81y7GMAJzODS8HZAwx9+ktubT30p9gawd1xWdejAplZeRt6CJFEQyP5KDj
    #       2PNGOJJ1Kiil7twEI6219IKyxdt4XRi9qAbHmdlvYIZc5vpF5QVzwO80s+XNnfAJ
    #       91qCNCk1QgribxXUhn2ueX9Dzz2yt6Oxr2/qqVDuStGjQdlmESVYJMCVKEHb26y/
    #       ENL8WHfRD6zDCGUN0EcaqYb7NriVNRBasxU9yfcsAQi1wjSje4OhEgGc5o8Ur7ID
    #       JIyrQfr9
    #       -----END CERTIFICATE-----
    # - hmac:
    #     secret: secret
    # - api_key:
    #     secret_key: secret

  metadata:
    - userinfo:
        oidc: keycloak
        client_id: authorino
        client_secret: 2e5246f2-f4ef-4d55-8225-36e725071dee
    - uma:
        endpoint: http://keycloak:8080/auth/realms/ostia
        client_id: pets-api
        client_secret: 523b92b6-625d-4e1e-a313-77e7a8ae4e88

  authorization:
    - opa:
        uuid: 8fa79d93-0f93-4e23-8c2a-666be266cad1
        endpoint: 'http://opa:8181'
        rego: |
          allow {
            http_request.method == "GET"
            path = ["pets"]
          }

          allow {
            http_request.method == "GET"
            own_resource
          }

          allow {
            http_request.method == "GET"
            path = ["stats"]
            is_admin
          }

          own_resource {
            some petid
            path = ["pets", petid]
            resource := object.get(metadata, "uma", [])[0]
            owner := object.get(object.get(resource, "owner", {}), "id", "")
            subject := object.get(identity, "sub", object.get(identity, "username", ""))
            owner == subject
          }

          is_admin {
            identity.realm_access.roles[_] == "admin"
          }
    - jwt:
        enabled: false
        match:
          http:
            path: '/api/*'
        claims:
          aud: api
